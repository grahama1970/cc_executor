{
  "review_id": "003_modularization",
  "component": "core_modularization",
  "date": "2025-06-25",
  "fixes": [
    {
      "id": 1,
      "severity": "critical",
      "file": "core/process_manager.py",
      "line": 40,
      "issue": "Shell-injection risk using /bin/bash -c",
      "fix": "Switch to create_subprocess_exec with shlex.split or validate command input.",
      "verification": "Add unit test attempting injection; expect rejection or safe execution."
    },
    {
      "id": 2,
      "severity": "critical",
      "file": "core/websocket_handler.py",
      "line": 1,
      "issue": "WebSocket accepts any origin, no authentication.",
      "fix": "Implement origin/API-key header check or token auth before accepting connection.",
      "verification": "Attempt unauthenticated connection; expect 403 close code."
    },
    {
      "id": 3,
      "severity": "major",
      "file": "core/stream_handler.py",
      "line": 150,
      "issue": "Fixed sleep back-pressure may lag at high throughput.",
      "fix": "Adopt queue with maxsize and writer.drain(); propagate CancelledError.",
      "verification": "Stress test at 5 MB/s; verify memory stays <100 MB and no lag >200 ms."
    },
    {
      "id": 4,
      "severity": "major",
      "file": "core/session_manager.py",
      "line": 120,
      "issue": "Race when removing expired sessions outside lock.",
      "fix": "Perform pop inside lock or re-check; add race-condition unit test.",
      "verification": "Concurrent remove/create fuzz test passes."
    },
    {
      "id": 5,
      "severity": "major",
      "file": "core/process_manager.py",
      "line": 110,
      "issue": "SIGKILL fallback missing after SIGTERM timeout.",
      "fix": "After configurable timeout send SIGKILL to pgid.",
      "verification": "Run process ignoring SIGTERM; expect forced kill <timeout+1s."
    },
    {
      "id": 6,
      "severity": "major",
      "file": "core/main.py",
      "line": 200,
      "issue": "Health endpoint lacks back-pressure metrics.",
      "fix": "Expose stream queue depth and avg latency in /health JSON.",
      "verification": "Curl /health and assert new fields present and numeric."
    },
    {
      "id": 7,
      "severity": "minor",
      "file": "core/models.py",
      "line": 120,
      "issue": "SessionInfo.websocket typed as Any.",
      "fix": "Use typing import for fastapi.WebSocket with TYPE_CHECKING guard.",
      "verification": "mypy passes with strict optional."
    },
    {
      "id": 8,
      "severity": "minor",
      "file": "core/config.py",
      "line": 1,
      "issue": "Hard-coded magic numbers for timeouts/buffer size.",
      "fix": "Read from env vars with sane defaults; document in README.",
      "verification": "Set env var override in test; assert value applied."
    },
    {
      "id": 9,
      "severity": "minor",
      "file": "core/__init__.py",
      "line": 1,
      "issue": "Public API not explicit.",
      "fix": "Add __all__ list for exported names.",
      "verification": "Import * only exposes listed symbols."
    }
  ]
}
